# Suica Viewer

Suica Viewer は、FeliCa ベースの交通系 IC カードから詳細な情報を取得し、表示・保存するためのツールです。暗号領域の読み出しにはリモート認証サーバーを利用し、コンソール向け CLI と Tkinter 製 GUI の 2 つのエントリーポイントを提供します。

## 主な機能
- リモートサーバー経由での相互認証と暗号領域読み出し
- CLI 版: 発行情報・残高・履歴・定期券情報などをテキストで整形出力
- GUI 版: 概要／発行情報／取引履歴／改札履歴／その他タブを備えたビジュアルビューア、履歴フィルタ、JSON のコピー・保存機能
- `station_codes.csv` に基づく会社名・路線名・駅名の解決
- `AUTH_SERVER_URL` 環境変数での認証サーバーの切り替え（既定: `https://felica-auth.nyaa.ws`）

## 必要環境
- Python 3.14 以降
- Poetry 1.8 以降
- nfcpy が対応している FeliCa リーダー／ライター（例: Sony RC-S380）
- PC 側で `libusb` など nfcpy が要求するドライバー／ライブラリがセットアップ済み
- インターネット接続（リモート認証サーバーとの通信に使用）

## セットアップ

```bash
poetry install
```

## 使い方 (CLI)
1. 対応する FeliCa リーダーを PC に接続
2. 必要であれば `AUTH_SERVER_URL` を設定し、リモートサーバーを指定
3. 下記コマンドでカードをかざすと、詳細情報がコンソールに出力

```bash
poetry run suica-viewer
# 例:
# AUTH_SERVER_URL=https://example.com poetry run suica-viewer
```

主な出力項目
- システム発行情報 (IDi, PMi)
- 発行情報 1・2（発行者／発行駅／有効期限など）
- 属性情報（カード種別・残高・取引通番）
- 取引履歴（入出場改札／物販／チャージなどを解析）
- 定期券情報、改札入出場情報、SF 改札入場情報

## 使い方 (GUI)
```bash
poetry run suica-viewer-gui
```

GUI では以下の機能が利用できます。
- 起動後に自動で NFC リーダーをポーリングし、カードを検知すると進捗バーを表示しつつ読み出し
- 概要タブで主要項目を一覧表示
- 発行情報タブで発行者・駅・ID など詳細を表示
- 履歴タブでは取引履歴をテーブル表示し、入力ボックスで全文検索フィルタが可能 (`Ctrl+F` / `Cmd+F` でフォーカス)
- 改札タブで改札履歴・装置番号・金額・定期区間を表示、SF 改札入場情報も併記
- その他タブで未知フィールドの値を確認
- 詳細タブでカード情報 JSON を閲覧し、クリップボードへコピーまたはファイル出力

## 認証サーバーの設定
- 既定値: `https://felica-auth.nyaa.ws`
- 環境変数 `AUTH_SERVER_URL` にベース URL を指定すると切り替え可能です（末尾スラッシュは不要）。
- サーバーは以下のエンドポイントを提供する必要があります。
  - `POST /mutual-authentication`
  - `POST /encryption-exchange`
- 相互認証の途中ステップではカードとのコマンド／レスポンスを往復させる想定です。状況によっては個人情報やカード識別子が送信されるため、信頼できる環境のみに接続してください。

## 駅コードデータ
- `suica_viewer/station_codes.csv` に JR 東日本などの駅コードが格納されており、線区コードと駅順コードから会社名・路線名・駅名を解決します。
- CSV を差し替えることで独自のデータセットに変更することも可能です。

## トラブルシューティング
- `NFC リーダーを初期化できません` と表示される場合: 対応ドライバーがインストールされているか、実行ユーザーに USB デバイスへのアクセス権限があるか確認してください。
- `サーバ通信エラー` が続く場合: 認証サーバー URL の設定やネットワーク接続を確認してください。必要に応じて `AUTH_SERVER_URL` を変更します。
- `FeliCa 以外のタグを検出しました` と表示される場合: 対応カードをかざしているかを確認してください。

## 開発向けメモ
- コード整形: `poetry run black suica_viewer`
- GUI のホットリロードはありません。UI 変更時はアプリを再起動してください。
- 既存の `__pycache__` などビルド成果物はリポジトリに含まれていないため、必要に応じてクリーンアップしてください。

## 開発者

- KIRISHIKI Yudai

## ライセンス

[MIT](https://opensource.org/licenses/MIT)

Copyright (c) 2025 KIRISHIKI Yudai
